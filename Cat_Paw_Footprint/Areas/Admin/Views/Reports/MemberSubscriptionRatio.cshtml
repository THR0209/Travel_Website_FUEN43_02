
<h1 class="mb-4">訂閱會員比例</h1>

<div class="container">
	<div class="row g-4">
		<!-- 左邊：訂閱 vs 非訂閱 -->
		<div class="col-md-6">
			<div class="card shadow-sm">
				<div class="card-header text-center fw-bold">
					訂閱 vs 非訂閱
				</div>
				<div class="card-body d-flex justify-content-center">
					<canvas id="memberSubscriptionChart" style="max-width: 400px;"></canvas>
				</div>
				<div class="card-footer text-muted text-center">
					最後更新：@DateTime.Now.ToString("yyyy/MM/dd HH:mm") <br>
					資料來源：會員資料表
				</div>
			</div>
		</div>

		<!-- 右邊：銅/銀/金 -->
		<div class="col-md-6">
			<div class="card shadow-sm">
				<div class="card-header text-center fw-bold">
					銅 / 銀 / 金 等級比例
				</div>
				<div class="card-body d-flex justify-content-center">
					<canvas id="memberLevelChart" style="max-width: 400px;"></canvas>
				</div>
				<div class="card-footer text-muted text-center">
					最後更新：@DateTime.Now.ToString("yyyy/MM/dd HH:mm") <br>
					資料來源：會員等級表
				</div>
			</div>
		</div>
	</div>

	<!-- 優惠券管理按鈕 -->
	<div class="row mt-4">
		<div class="col text-center">
			<a asp-area="CouponManagement" asp-controller="Coupons" asp-action="Index" class="btn btn-primary">
				優惠券管理
			</a>
		</div>
	</div>
</div>





@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // ===== 第一張：訂閱 vs 非訂閱 =====
            fetch('/Admin/Reports/GetMemberSubscriptionRatio')
                .then(res => res.json())
                .then(data => {
                    const ctx = document.getElementById('memberSubscriptionChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: data.map(x => x.label),
                            datasets: [{
                                data: data.map(x => x.count),
                                backgroundColor: [
                                    'rgba(54, 162, 235, 0.7)',  // 訂閱
                                    'rgba(255, 99, 132, 0.7)'   // 非訂閱
                                ],
                                borderColor: [
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 99, 132, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: true, text: '訂閱會員比例' }
                            }
                        }
                    });
                })
                .catch(error => console.error('訂閱 vs 非訂閱 API 錯誤:', error));

          // ===== 第二張：等級比例（銅/銀/金） =====
        fetch('/Admin/Reports/GetMemberLevelRatio')
            .then(res => res.json())
            .then(data => {
                // 固定順序：Bronze → Silver → Gold
                const order = ["Bronze", "Silver", "Gold"];
                data.sort((a, b) => order.indexOf(a.label) - order.indexOf(b.label));

                const labels = data.map(x => x.label);
                const counts = data.map(x => x.count);

                const ctx2 = document.getElementById('memberLevelChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: [
                                'rgba(205, 127, 50, 0.7)',   // Bronze
                                'rgba(192, 192, 192, 0.7)',  // Silver
                                'rgba(255, 215, 0, 0.7)'     // Gold
                            ],
                            borderColor: [
                                'rgba(205, 127, 50, 1)',
                                'rgba(192, 192, 192, 1)',
                                'rgba(255, 215, 0, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: '訂閱會員等級比例' }
                        }
                    }
                });
            })
            .catch(error => console.error('會員等級比例 API 錯誤:', error));

        });
    </script>
}
