@{
    ViewData["Title"] = "儀表板";
}
@model Cat_Paw_Footprint.Areas.Admin.ViewModel.DashboardViewModel

<div class="card">
    <div class="card-body">
        <h2 class="mb-4 text-center">儀表板</h2>
        <div class="row g-3">
            <!-- 本月訂單 -->
            <div class="col-md-3 col-sm-6 col-12">
                <div class="card p-3 rounded-4 position-relative shadow-sm h-100">
                    <h5>本月訂單</h5>
                    <h2>@Model.MonthlyOrders</h2>
                    <a asp-area="Admin" asp-controller="Reports" asp-action="SalesReport" class="btn btn-outline-success stretched-link">
                        <small class="@(Model.OrderGrowthRate >= 0 ? "text-success" : "text-danger") fs-6">
                        @(Model.OrderGrowthRate >= 0 ? "比上月新增" : "比上月減少")
                        @Model.OrderGrowthRate.ToString("F1")%
                    </small>
                    </a>
                </div>
            </div>
            <!-- 開放行程 -->
            <div class="col-md-3 col-sm-6 col-12">
                <div class="card p-3 rounded-4 position-relative shadow-sm h-100">
                    <h5>開放行程</h5>
                    <h2>@Model.OpenTrips</h2>
                    <a asp-area="Admin" asp-controller="Reports" asp-action="HotProducts" class="btn btn-outline-success stretched-link fs-6">即時狀態</a>
                </div>
            </div>
            <!-- 客戶總數 -->
            <div class="col-md-3 col-sm-6 col-12">
                <div class="card p-3 rounded-4 position-relative shadow-sm h-100">
                    <h5>客戶總數</h5>
                    <h2>@Model.CustomerCount</h2>
                    <a asp-area="Admin" asp-controller="Reports" asp-action="MemberSubscriptionRatio" class="btn btn-outline-success stretched-link fs-6">
                        <span class="@(Model.CustomerGrowthRate >= 0 ? "text-success" : "text-danger") fs-6">
                        @(Model.CustomerGrowthRate >= 0 ? "比上月新增" : "比上月減少")
                        @Model.CustomerGrowthRate.ToString("F1")%
                    </span>
                    </a>
                </div>
            </div>
            <!-- 本月已解決案件數 -->
            <div class="col-md-3 col-sm-6 col-12">
                <div class="card p-3 rounded-4 position-relative shadow-sm h-100">
                    <h5>本月已解決案件數</h5>
                    <h2>@Model.ResolvedThisMonth</h2>
                    <a asp-area="Admin" asp-controller="Reports" asp-action="CustomerServiceAnalysis" class="btn btn-outline-success stretched-link fs-6">
                        <span class="@(Model.TicketGrowthRate >= 0 ? "text-success" : "text-danger")">
                        @(Model.TicketGrowthRate >= 0 ? "比上月新增" : "比上月減少")
                        @Model.TicketGrowthRate.ToString("F1")%
                    </span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<hr class="my-4" />
<div class="card mb-4">
    <div class="card-body">
        <h2 class="mb-4 text-center">銷售報表</h2>
        <div class="row mb-4 justify-content-center">
            <div class="col-md-3 col-sm-6 mb-2">
                <select id="chartType" class="form-select">
                    <option value="bar" selected>柱狀圖</option>
                    <option value="line">折線圖</option>
                    <option value="pie">圓餅圖</option>
                </select>
            </div>
            <div class="col-md-3 col-sm-6 mb-2">
                <select id="timeRange" class="form-select">
                    <option value="day">日報表</option>
                    <option value="month" selected>月報表</option>
                    <option value="quarter">季報表</option>
                    <option value="year">年報表</option>
                </select>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-12 d-flex justify-content-center">
                <div class="bg-light rounded p-4 text-center" style="width:100%;max-width:1300px;">
                    <!-- 直接設 canvas width/height，JS繪圖更清晰 -->
                    <div class="col-12">
                        <div class="card shadow-sm" style="background-color:#F5F7FA;">
                            <canvas id="salesChart" width="1200" height="600" style="max-width:100%;"></canvas>
                
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let ctx = document.getElementById('salesChart').getContext('2d');
        let chart;

                function initChart(type, labels = [], data = []) {
            if (chart) chart.destroy();

            let datasetConfig = {
                label: '銷售額',
                data: data,
                borderWidth: 1
            };

            if (type === "pie") {
                datasetConfig.backgroundColor = [
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)'
                ];
            } else {
                datasetConfig.backgroundColor = 'rgba(54, 162, 235, 0.7)';
                datasetConfig.borderColor = 'rgba(54, 162, 235, 1)';
            }

            chart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [datasetConfig]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        title: {
                            display: true,
                            text: '📊 銷售額趨勢',
                            font: { size: 32, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let value = context.raw || 0;
                                    return `銷售額: ${value.toLocaleString()} 元`;
                                }
                            }
                        }
                        // 如果有 datalabels plugin，這裡可以加 datalabels
                        // datalabels: {
                        //     display: true,
                        //     font: { size: 22, weight: 'bold' },
                        //     color: '#333'
                        // }
                    },
                    scales: type !== "pie" ? {
                        x: {
                            title: {
                                display: true,
                                text: '時間區間',
                                font: { size: 20, weight: 'bold' }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '銷售額 (元)',
                                font: { size: 20, weight: 'bold' }
                            }
                        }
                    } : {}
                }
                // plugins: [ChartDataLabels] // 若需要 datalabels
            });
        }

        function loadData(groupBy) {
            fetch(`/Admin/Reports/GetSalesReport?groupBy=${groupBy}`)
                .then(r => r.json())
                .then(data => {
                    let labels = data.map(d => d.x);
                    let values = data.map(d => d.y);
                    let chartType = document.getElementById('chartType').value;
                    initChart(chartType, labels, values);
                })
                .catch(err => console.error("載入銷售報表錯誤:", err));
        }

        document.getElementById('timeRange').addEventListener('change', function () {
            loadData(this.value);
        });

        document.getElementById('chartType').addEventListener('change', function () {
            loadData(document.getElementById('timeRange').value);
        });

        loadData("month");
    </script>
}
