@model IEnumerable<Cat_Paw_Footprint.Models.Products>

@{
    ViewData["Title"] = "產品管理";
}

@section Styles {
    <link href="~/lib/datatables/css/jquery.datatables.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/2.3.1/css/dataTables.dataTables.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/fixedheader/4.0.2/css/fixedHeader.bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/buttons/3.2.4/css/buttons.dataTables.css" rel="stylesheet" />
    <link href="~/lib/datatables/css/mydatatables.css" rel="stylesheet" />
    <style>
        .my-copy {
            background-color: #6c757d !important; /* 灰色 */
            border-color: #6c757d !important;
            color: white !important;
        }

        .my-excel {
            background-color: #198754 !important; /* 綠色 */
            border-color: #198754 !important;
            color: white !important;
        }

        .my-pdf {
            background-color: #dc3545 !important; /* 紅色 */
            border-color: #dc3545 !important;
            color: white !important;
        }

        #test thead th {
            background-color: #22B3C1;
            color: white;
            font-family: "Chiron GoRound TC", sans-serif;
            font-size: 15px;
        }

        .btn-size {
            width: 80%;
            text-align: center;
        }

        table.dataTable thead th:first-child {
            border-top-left-radius: 8px;
        }

        table.dataTable thead th:last-child {
            border-top-right-radius: 8px;
        }

    </style>
}

<h1>產品管理</h1>

<p>
    <a asp-action="Create" class="btn btn-primary"><i class="fa-solid fa-square-plus"></i> 新增產品</a>
</p>
<div class="card">
    <table id="test" class="table table-striped table-hover table-bordered">
        <thead class="table-primary">
            <tr class="text-center">
                <th>ID</th>
                <th>流水號</th>
                <th>產品名稱</th>
                <th>產品圖片</th>
                <th>價格</th>
                <th>出團時間</th>
                <th>上架時間</th>
                <th>狀態</th>
                <th>人數上限</th>
            </tr>
        </thead>
    </table>

    <!-- Bootstrap Toast 容器 -->
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-fixed top-0 end-0 p-3">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            @TempData["SuccessMessage"]
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            @TempData["ErrorMessage"]
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>


@section Scripts {
    <script src="~/lib/datatables/js/jquery.datatables.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.datatables.net/2.3.1/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/4.0.2/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.4/js/dataTables.buttons.js"></script>
    @* <script src="https://cdn.datatables.net/buttons/3.2.4/js/buttons.dataTables.js"></script> *@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.4/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.4/js/buttons.print.min.js"></script>

    <!-- dayjs 核心 -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <script>
        // 自動顯示所有 Toast
        document.addEventListener("DOMContentLoaded", function () {
            var toastElList = [].slice.call(document.querySelectorAll('.toast'));
            var toastList = toastElList.map(function (toastEl) {
                var t = new bootstrap.Toast(toastEl);
                t.show(); // 顯示
                return t;
            });
        });
    </script>


    <script>
        DataTable.type('num', 'className', 'dt-body-right');
        DataTable.type('num-fmt', 'className', 'dt-body-right');
        DataTable.type('date', 'className', 'dt-body-right');


         $(document).ready(function () {
            $('#test').dataTable({
                ajax: {
                    type: 'POST',
                    url: '@Url.Action("IndexJson", "Products", new { area = "ProductManagement" })',
                    dataSrc: ''
                },
                columns: [
                    { data: "productID", visible: false },
                    { data: "productCode", title: "產品編號", "width": "5%" },
                    {
                        data: "productID",
                        title: "產品封面照", "width": "10%",
                        className: 'text-center align-middle',
                        render: imgRender
                    },
                    { data: "productName", title: "產品名稱", "width": "15%" },
                    { data: "isActive", title: "狀態", width: "8%", render: statusRender, className:"dt-center" },
                    { data: "productPrice", title: "價格", "width": "10%" },
                    {
                        data: "startDate",
                        title: "出團時間",
                        width: "10%",
                        render: function (data) {
                            return data ? dayjs(data).format("YYYY-MM-DD A hh:mm").replace("AM", "上午").replace("PM", "下午") : "";
                        }
                    },
                    {
                        data: "analyses[0].releaseDate",
                        title: "上架時間",
                        width: "10%",
                        render: function (data) {
                            return data ? dayjs(data).format("YYYY-MM-DD A hh:mm").replace("AM", "上午").replace("PM", "下午") : "";
                        }
                    },
                    { data: "maxPeople", title: "人數上限", "width": "10%" },
                    {
                        data: null,
                        title: "操作",
                        orderable: false,
                        searchable: false,
                        width: "10%",
                        render: function (data, type, row) {
                            return `
                               <a href="/ProductManagement/Products/Edit/${row.productID}" class="btn btn-sm btn-primary ms-2 mb-2 btn-size">編輯</a>
                               <a href="/ProductManagement/Products/Details/${row.productID}" class="btn btn-sm btn-secondary ms-2 mb-2 btn-size">詳細內容</a>
                               <button onclick="deactivateProduct(${row.productID})" class="btn btn-sm btn-danger ms-2 mb-2 btn-size">下架</button>
                            `;
                        }
                    }
                ],
                order: [[0, 'desc']],
                fixedHeader: { header: true },
                language: {
                    url:'https://cdn.datatables.net/plug-ins/1.13.1/i18n/zh-HANT.json'
                },
                // dom: 'Bftip',
                // buttons: [
                //     {
                //         extend: 'copy',
                //         text: '📋 複製',
                //         className: 'btn btn-secondary my-copy'
                //     },
                //     {
                //         extend: 'csv',
                //         text: '📊 匯出 Excel',
                //         className: 'btn btn-success my-excel',
                //         filename: '產品清單',
                //         title: '我的產品資料'
                //     },
                //     {
                //         extend: 'pdf',
                //         text: '📄 下載 PDF',
                //         className: 'btn btn-danger my-pdf',
                //         filename: '產品清單',
                //         title: '我的產品資料'
                //     }
                // ]
            });
         });

        // function imgRender(b64) {  二進位轉回圖片
        //     if (!b64) return '';
        //     byte[] 會被序列化成 base64 字串
        //     return `<img class="d-block mx-auto rounded-2" src="data:image/*;base64,${b64}" style="width:120px;height:80px;object-fit:cover;border-radius:6px;">`;
        // };

        function imgRender(productID) {
            if (!productID) return '';
            // 透過後端提供的 URL 載入圖片
            const imageUrl = `/ProductManagement/Products/GetProductImage/${productID}`;
            return `<img class="d-block mx-auto rounded-2" src="${imageUrl}"
                        style="width:160px;height:120px;object-fit:contain;border-radius:6px;">`;
        }

        function statusRender(status) {
            if (status) {
                return `<span class="badge bg-success text-center">上架中</span>`;
            }
            else {
                return  `<span class="badge bg-danger text-center">下架</span>`;
            }
        }

        function deactivateProduct(id) {
            if (confirm("確定要下架這個產品嗎？")) {
                $.ajax({
                    url: '@Url.Action("Deactivate", "Products", new { area = "ProductManagement" })',
                    type: 'POST',
                    data: { id: id },
                    success: function (res) {
                        if (res.success) {
                            alert("已成功下架！");
                            $('#test').DataTable().ajax.reload(); // 重新載入 DataTable
                        } else {
                            alert("操作失敗！");
                        }
                    },
                    error: function () {
                        alert("發生錯誤，請稍後再試。");
                    }
                });
            }
        }

    </script>
}
